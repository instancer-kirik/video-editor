<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Zig WASM Video Editor Test</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: #1a1a1a;
                color: #ffffff;
                line-height: 1.6;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
                padding: 20px 0;
                border-bottom: 2px solid #333;
            }

            .header h1 {
                font-size: 2.5rem;
                margin-bottom: 10px;
                background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .status {
                padding: 15px;
                margin: 10px 0;
                border-radius: 8px;
                font-weight: 500;
            }

            .status.loading {
                background: #ffa500;
                color: #000;
            }

            .status.success {
                background: #4caf50;
                color: #fff;
            }

            .status.error {
                background: #f44336;
                color: #fff;
            }

            .test-section {
                background: #2a2a2a;
                border-radius: 12px;
                padding: 25px;
                margin: 20px 0;
                border: 1px solid #404040;
            }

            .test-section h2 {
                margin-bottom: 15px;
                color: #4ecdc4;
                font-size: 1.3rem;
            }

            .video-preview {
                width: 100%;
                max-width: 640px;
                height: 360px;
                background: #000;
                border-radius: 8px;
                margin: 15px 0;
                position: relative;
                overflow: hidden;
            }

            .video-preview video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .video-preview canvas {
                width: 100%;
                height: 100%;
                display: block;
            }

            .controls {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin: 15px 0;
            }

            .btn {
                background: #4ecdc4;
                color: #000;
                border: none;
                padding: 12px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .btn:hover {
                background: #45b7aa;
                transform: translateY(-2px);
            }

            .btn:disabled {
                background: #666;
                color: #999;
                cursor: not-allowed;
                transform: none;
            }

            .btn.danger {
                background: #ff6b6b;
                color: white;
            }

            .btn.danger:hover {
                background: #ff5252;
            }

            .slider-group {
                margin: 15px 0;
            }

            .slider-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
            }

            .slider {
                width: 100%;
                height: 6px;
                border-radius: 3px;
                background: #444;
                outline: none;
                -webkit-appearance: none;
            }

            .slider::-webkit-slider-thumb {
                appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #4ecdc4;
                cursor: pointer;
            }

            .slider::-moz-range-thumb {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #4ecdc4;
                cursor: pointer;
                border: none;
            }

            .info-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 15px 0;
            }

            .info-card {
                background: #333;
                padding: 15px;
                border-radius: 8px;
                text-align: center;
            }

            .info-card h3 {
                color: #4ecdc4;
                margin-bottom: 5px;
            }

            .info-card .value {
                font-size: 1.5rem;
                font-weight: bold;
            }

            .test-results {
                background: #1e1e1e;
                border: 1px solid #444;
                border-radius: 8px;
                padding: 15px;
                margin: 15px 0;
                font-family: "Courier New", monospace;
                font-size: 0.9rem;
                max-height: 200px;
                overflow-y: auto;
            }

            .recording-indicator {
                display: none;
                background: #ff4444;
                color: white;
                padding: 10px 15px;
                border-radius: 20px;
                font-weight: bold;
                animation: pulse 1s infinite;
            }

            .recording-indicator.active {
                display: inline-block;
            }

            @keyframes pulse {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.7;
                }
                100% {
                    opacity: 1;
                }
            }

            .text-overlay-controls {
                background: #333;
                padding: 15px;
                border-radius: 8px;
                margin: 15px 0;
            }

            .text-overlay-controls input {
                background: #444;
                border: 1px solid #666;
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                margin: 5px;
            }

            @media (max-width: 768px) {
                .container {
                    padding: 10px;
                }

                .controls {
                    justify-content: center;
                }

                .btn {
                    flex: 1;
                    min-width: 120px;
                }

                .info-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üé¨ Zig WASM Video Editor</h1>
                <p>Testing TikTok-style video recording and editing</p>
                <div id="wasm-status" class="status loading">
                    Loading WASM module...
                </div>
            </div>

            <!-- Camera & Recording Section -->
            <div class="test-section">
                <h2>üìπ Camera & Recording</h2>
                <div class="recording-indicator" id="recordingIndicator">
                    ‚óè REC
                </div>

                <div class="video-preview">
                    <video id="cameraVideo" autoplay muted playsinline></video>
                    <canvas id="previewCanvas" style="display: none"></canvas>
                </div>

                <div class="controls">
                    <button class="btn" id="startCameraBtn">
                        üì∑ Start Camera
                    </button>
                    <button class="btn" id="startRecordBtn" disabled>
                        üî¥ Start Recording
                    </button>
                    <button class="btn danger" id="stopRecordBtn" disabled>
                        ‚èπÔ∏è Stop Recording
                    </button>
                    <button class="btn" id="switchCameraBtn" disabled>
                        üîÑ Switch Camera
                    </button>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <h3>Status</h3>
                        <div class="value" id="recordingStatus">Idle</div>
                    </div>
                    <div class="info-card">
                        <h3>Resolution</h3>
                        <div class="value" id="resolution">0x0</div>
                    </div>
                    <div class="info-card">
                        <h3>Frame Rate</h3>
                        <div class="value" id="frameRate">0 fps</div>
                    </div>
                    <div class="info-card">
                        <h3>Memory Usage</h3>
                        <div class="value" id="memoryUsage">0 KB</div>
                    </div>
                </div>
            </div>

            <!-- Video Filters Section -->
            <div class="test-section">
                <h2>üé® Real-time Filters</h2>

                <div class="slider-group">
                    <label for="brightnessSlider"
                        >Brightness:
                        <span id="brightnessValue">1.0</span></label
                    >
                    <input
                        type="range"
                        id="brightnessSlider"
                        class="slider"
                        min="0"
                        max="2"
                        step="0.1"
                        value="1"
                    />
                </div>

                <div class="slider-group">
                    <label for="contrastSlider"
                        >Contrast: <span id="contrastValue">1.0</span></label
                    >
                    <input
                        type="range"
                        id="contrastSlider"
                        class="slider"
                        min="0"
                        max="2"
                        step="0.1"
                        value="1"
                    />
                </div>

                <div class="slider-group">
                    <label for="saturationSlider"
                        >Saturation:
                        <span id="saturationValue">1.0</span></label
                    >
                    <input
                        type="range"
                        id="saturationSlider"
                        class="slider"
                        min="0"
                        max="2"
                        step="0.1"
                        value="1"
                    />
                </div>

                <div class="controls">
                    <button class="btn" id="resetFiltersBtn">
                        üîÑ Reset Filters
                    </button>
                    <button class="btn" id="applyFiltersBtn" disabled>
                        ‚ú® Apply to Frame
                    </button>
                </div>
            </div>

            <!-- Text Overlays Section -->
            <div class="test-section">
                <h2>üìù Text Overlays</h2>

                <div class="text-overlay-controls">
                    <input
                        type="text"
                        id="textInput"
                        placeholder="Enter text..."
                        value="Hello TikTok!"
                    />
                    <input
                        type="number"
                        id="textX"
                        placeholder="X position"
                        value="100"
                        min="0"
                        max="640"
                    />
                    <input
                        type="number"
                        id="textY"
                        placeholder="Y position"
                        value="100"
                        min="0"
                        max="360"
                    />
                    <input
                        type="number"
                        id="fontSize"
                        placeholder="Font size"
                        value="24"
                        min="12"
                        max="72"
                    />
                    <input type="color" id="textColor" value="#ffffff" />
                </div>

                <div class="controls">
                    <button class="btn" id="addTextBtn">‚ûï Add Text</button>
                    <button class="btn danger" id="clearTextBtn">
                        üóëÔ∏è Clear All Text
                    </button>
                </div>

                <div class="info-card">
                    <h3>Active Overlays</h3>
                    <div class="value" id="textOverlayCount">0</div>
                </div>
            </div>

            <!-- Timeline & Export Section -->
            <div class="test-section">
                <h2>‚è±Ô∏è Timeline & Export</h2>

                <div class="slider-group">
                    <label for="timelineSlider"
                        >Timeline Position:
                        <span id="timelineValue">0.0s</span></label
                    >
                    <input
                        type="range"
                        id="timelineSlider"
                        class="slider"
                        min="0"
                        max="10"
                        step="0.1"
                        value="0"
                    />
                </div>

                <div class="controls">
                    <button class="btn" id="setRangeBtn">
                        üìê Set Range (0-5s)
                    </button>
                    <button class="btn" id="exportBtn" disabled>
                        üíæ Export Video
                    </button>
                    <button class="btn" id="downloadBtn" disabled>
                        ‚¨áÔ∏è Download
                    </button>
                </div>
            </div>

            <!-- WASM Tests Section -->
            <div class="test-section">
                <h2>üß™ WASM Function Tests</h2>

                <div class="controls">
                    <button class="btn" id="testMathBtn">üî¢ Test Math</button>
                    <button class="btn" id="testMemoryBtn">
                        üíæ Test Memory
                    </button>
                    <button class="btn" id="testVideoStateBtn">
                        üìπ Test Video State
                    </button>
                    <button class="btn" id="runAllTestsBtn">
                        üöÄ Run All Tests
                    </button>
                </div>

                <div class="test-results" id="testResults">
                    Ready to run tests...
                </div>
            </div>

            <!-- Error Log Section -->
            <div class="test-section">
                <h2>üîç Debug & Errors</h2>
                <div class="test-results" id="errorLog">No errors yet...</div>
                <div class="controls">
                    <button class="btn" id="clearLogBtn">üóëÔ∏è Clear Log</button>
                    <button class="btn" id="getWasmErrorBtn">
                        ‚ö†Ô∏è Get WASM Error
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Global variables
            let wasmModule = null;
            let wasmMemory = null;
            let mediaStream = null;
            let mediaRecorder = null;
            let recordedChunks = [];
            let animationId = null;
            let canvas = null;
            let ctx = null;

            // Utility functions
            function log(message, type = "info") {
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.getElementById("errorLog");
                const colorMap = {
                    error: "#ff6b6b",
                    success: "#4caf50",
                    warning: "#ffa500",
                    info: "#4ecdc4",
                };

                logElement.innerHTML += `<div style="color: ${colorMap[type] || "#4ecdc4"};">[${timestamp}] ${message}</div>`;
                logElement.scrollTop = logElement.scrollHeight;
            }

            function updateStatus(message, type = "loading") {
                const statusEl = document.getElementById("wasm-status");
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            }

            function updateInfo() {
                if (!wasmModule) return;

                try {
                    document.getElementById("recordingStatus").textContent =
                        wasmModule.is_recording() ? "Recording" : "Idle";
                    document.getElementById("resolution").textContent =
                        `${wasmModule.get_width()}x${wasmModule.get_height()}`;
                    document.getElementById("frameRate").textContent =
                        `${wasmModule.get_frame_rate()} fps`;
                    document.getElementById("memoryUsage").textContent =
                        `${Math.round(wasmModule.get_memory_usage() / 1024)} KB`;
                    document.getElementById("textOverlayCount").textContent =
                        wasmModule.get_text_overlay_count();
                } catch (error) {
                    log(`Error updating info: ${error.message}`, "error");
                }
            }

            // WASM Loading
            async function loadWasm() {
                try {
                    updateStatus("Loading WASM module...", "loading");

                    const wasmResponse = await fetch("./video-editor.wasm");
                    if (!wasmResponse.ok) {
                        throw new Error(
                            `Failed to load WASM: ${wasmResponse.status}`,
                        );
                    }

                    const wasmBytes = await wasmResponse.arrayBuffer();
                    const wasmResult = await WebAssembly.instantiate(
                        wasmBytes,
                        {},
                    );

                    wasmModule = wasmResult.instance.exports;
                    wasmMemory = wasmModule.memory;

                    // Initialize the video editor
                    wasmModule.init_video_editor();

                    updateStatus("‚úÖ WASM loaded successfully!", "success");
                    log("WASM module loaded and initialized", "success");

                    setupEventListeners();
                    updateInfo();
                    setInterval(updateInfo, 1000); // Update info every second
                } catch (error) {
                    updateStatus(
                        `‚ùå Failed to load WASM: ${error.message}`,
                        "error",
                    );
                    log(`WASM loading error: ${error.message}`, "error");
                }
            }

            // Camera functions
            async function startCamera() {
                try {
                    const constraints = {
                        video: {
                            width: 1280,
                            height: 720,
                            frameRate: 30,
                        },
                        audio: true,
                    };

                    mediaStream =
                        await navigator.mediaDevices.getUserMedia(constraints);
                    const video = document.getElementById("cameraVideo");
                    video.srcObject = mediaStream;

                    // Set up canvas for processing
                    canvas = document.getElementById("previewCanvas");
                    ctx = canvas.getContext("2d");
                    canvas.width = 1280;
                    canvas.height = 720;

                    document.getElementById("startRecordBtn").disabled = false;
                    document.getElementById("switchCameraBtn").disabled = false;
                    document.getElementById("applyFiltersBtn").disabled = false;

                    log("Camera started successfully", "success");
                } catch (error) {
                    log(`Camera error: ${error.message}`, "error");
                }
            }

            function startRecording() {
                try {
                    if (wasmModule.start_recording() === 0) {
                        document
                            .getElementById("recordingIndicator")
                            .classList.add("active");
                        document.getElementById("startRecordBtn").disabled =
                            true;
                        document.getElementById("stopRecordBtn").disabled =
                            false;
                        log("Recording started", "success");
                    } else {
                        throw new Error("Failed to start recording in WASM");
                    }
                } catch (error) {
                    log(`Recording start error: ${error.message}`, "error");
                }
            }

            function stopRecording() {
                try {
                    if (wasmModule.stop_recording() === 0) {
                        document
                            .getElementById("recordingIndicator")
                            .classList.remove("active");
                        document.getElementById("startRecordBtn").disabled =
                            false;
                        document.getElementById("stopRecordBtn").disabled =
                            true;
                        document.getElementById("exportBtn").disabled = false;
                        log("Recording stopped", "success");
                    } else {
                        throw new Error("Failed to stop recording in WASM");
                    }
                } catch (error) {
                    log(`Recording stop error: ${error.message}`, "error");
                }
            }

            // Filter functions
            function applyFilters() {
                if (!wasmModule || !ctx || !mediaStream) return;

                const video = document.getElementById("cameraVideo");
                const canvas = document.getElementById("previewCanvas");

                // Draw video frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Get image data
                const imageData = ctx.getImageData(
                    0,
                    0,
                    canvas.width,
                    canvas.height,
                );

                // Apply WASM filters
                const dataPtr = wasmModule.alloc(imageData.data.length);
                if (dataPtr) {
                    const wasmData = new Uint8Array(
                        wasmMemory.buffer,
                        dataPtr,
                        imageData.data.length,
                    );
                    wasmData.set(imageData.data);

                    wasmModule.process_frame(
                        dataPtr,
                        canvas.width,
                        canvas.height,
                    );

                    imageData.data.set(wasmData);
                    ctx.putImageData(imageData, 0, 0);
                }
            }

            // Test functions
            function runTests() {
                const results = document.getElementById("testResults");
                results.innerHTML = "";

                try {
                    // Math test
                    const mathResult = wasmModule.test_basic_math();
                    results.innerHTML += `<div style="color: ${mathResult === 8 ? "#4caf50" : "#ff6b6b"};">Math Test: ${mathResult} (expected 8)</div>`;

                    // Memory test
                    const memResult = wasmModule.test_memory();
                    results.innerHTML += `<div style="color: ${memResult === 1 ? "#4caf50" : "#ff6b6b"};">Memory Test: ${memResult ? "PASS" : "FAIL"}</div>`;

                    // Video state test
                    const videoResult = wasmModule.test_video_state();
                    results.innerHTML += `<div style="color: ${videoResult === 1 ? "#4caf50" : "#ff6b6b"};">Video State Test: ${videoResult ? "PASS" : "FAIL"}</div>`;

                    // Version info
                    const version = `${wasmModule.get_version_major()}.${wasmModule.get_version_minor()}.${wasmModule.get_version_patch()}`;
                    results.innerHTML += `<div style="color: #4ecdc4;">WASM Version: ${version}</div>`;

                    log("All tests completed", "success");
                } catch (error) {
                    results.innerHTML += `<div style="color: #ff6b6b;">Test Error: ${error.message}</div>`;
                    log(`Test error: ${error.message}`, "error");
                }
            }

            // Event listeners setup
            function setupEventListeners() {
                // Camera controls
                document
                    .getElementById("startCameraBtn")
                    .addEventListener("click", startCamera);
                document
                    .getElementById("startRecordBtn")
                    .addEventListener("click", startRecording);
                document
                    .getElementById("stopRecordBtn")
                    .addEventListener("click", stopRecording);

                // Filter controls
                const brightnessSlider =
                    document.getElementById("brightnessSlider");
                const contrastSlider =
                    document.getElementById("contrastSlider");
                const saturationSlider =
                    document.getElementById("saturationSlider");

                brightnessSlider.addEventListener("input", (e) => {
                    const value = parseFloat(e.target.value);
                    wasmModule.apply_brightness(value);
                    document.getElementById("brightnessValue").textContent =
                        value.toFixed(1);
                });

                contrastSlider.addEventListener("input", (e) => {
                    const value = parseFloat(e.target.value);
                    wasmModule.apply_contrast(value);
                    document.getElementById("contrastValue").textContent =
                        value.toFixed(1);
                });

                saturationSlider.addEventListener("input", (e) => {
                    const value = parseFloat(e.target.value);
                    wasmModule.apply_saturation(value);
                    document.getElementById("saturationValue").textContent =
                        value.toFixed(1);
                });

                document
                    .getElementById("resetFiltersBtn")
                    .addEventListener("click", () => {
                        brightnessSlider.value = 1;
                        contrastSlider.value = 1;
                        saturationSlider.value = 1;
                        wasmModule.apply_brightness(1.0);
                        wasmModule.apply_contrast(1.0);
                        wasmModule.apply_saturation(1.0);
                        document.getElementById("brightnessValue").textContent =
                            "1.0";
                        document.getElementById("contrastValue").textContent =
                            "1.0";
                        document.getElementById("saturationValue").textContent =
                            "1.0";
                    });

                document
                    .getElementById("applyFiltersBtn")
                    .addEventListener("click", applyFilters);

                // Text overlay controls
                document
                    .getElementById("addTextBtn")
                    .addEventListener("click", () => {
                        const text = document.getElementById("textInput").value;
                        const x = parseFloat(
                            document.getElementById("textX").value,
                        );
                        const y = parseFloat(
                            document.getElementById("textY").value,
                        );
                        const fontSize = parseInt(
                            document.getElementById("fontSize").value,
                        );
                        const color =
                            document.getElementById("textColor").value;

                        // Convert hex color to RGBA u32
                        const colorInt =
                            parseInt(color.substring(1), 16) | 0xff000000;

                        const textPtr = wasmModule.alloc(text.length);
                        if (textPtr) {
                            const wasmText = new Uint8Array(
                                wasmMemory.buffer,
                                textPtr,
                                text.length,
                            );
                            for (let i = 0; i < text.length; i++) {
                                wasmText[i] = text.charCodeAt(i);
                            }

                            const result = wasmModule.add_text_overlay(
                                x,
                                y,
                                textPtr,
                                text.length,
                                fontSize,
                                colorInt,
                            );
                            if (result >= 0) {
                                log(
                                    `Text overlay added at index ${result}`,
                                    "success",
                                );
                            } else {
                                log("Failed to add text overlay", "error");
                            }
                        }
                    });

                document
                    .getElementById("clearTextBtn")
                    .addEventListener("click", () => {
                        wasmModule.clear_text_overlays();
                        log("All text overlays cleared", "success");
                    });

                // Timeline controls
                const timelineSlider =
                    document.getElementById("timelineSlider");
                timelineSlider.addEventListener("input", (e) => {
                    const time = parseFloat(e.target.value);
                    wasmModule.set_current_time(time);
                    document.getElementById("timelineValue").textContent =
                        `${time.toFixed(1)}s`;
                });

                document
                    .getElementById("setRangeBtn")
                    .addEventListener("click", () => {
                        wasmModule.set_timeline_range(0.0, 5.0);
                        log("Timeline range set to 0-5 seconds", "success");
                    });

                // Test controls
                document
                    .getElementById("testMathBtn")
                    .addEventListener("click", () => {
                        const result = wasmModule.test_basic_math();
                        document.getElementById("testResults").innerHTML =
                            `Math test result: ${result}`;
                    });

                document
                    .getElementById("testMemoryBtn")
                    .addEventListener("click", () => {
                        const result = wasmModule.test_memory();
                        document.getElementById("testResults").innerHTML =
                            `Memory test: ${result ? "PASS" : "FAIL"}`;
                    });

                document
                    .getElementById("testVideoStateBtn")
                    .addEventListener("click", () => {
                        const result = wasmModule.test_video_state();
                        document.getElementById("testResults").innerHTML =
                            `Video state test: ${result ? "PASS" : "FAIL"}`;
                    });

                document
                    .getElementById("runAllTestsBtn")
                    .addEventListener("click", runTests);

                // Debug controls
                document
                    .getElementById("clearLogBtn")
                    .addEventListener("click", () => {
                        document.getElementById("errorLog").innerHTML =
                            "Log cleared...";
                    });

                document
                    .getElementById("getWasmErrorBtn")
                    .addEventListener("click", () => {
                        try {
                            const errorPtr = wasmModule.get_last_error();
                            const errorLen = wasmModule.get_last_error_len();
                            if (errorLen > 0) {
                                const errorData = new Uint8Array(
                                    wasmMemory.buffer,
                                    errorPtr,
                                    errorLen,
                                );
                                const errorMsg = new TextDecoder().decode(
                                    errorData,
                                );
                                log(`WASM Error: ${errorMsg}`, "warning");
                            } else {
                                log("No WASM errors", "info");
                            }
                        } catch (error) {
                            log(
                                `Error getting WASM error: ${error.message}`,
                                "error",
                            );
                        }
                    });
            }

            // Initialize everything
            document.addEventListener("DOMContentLoaded", loadWasm);
        </script>
    </body>
</html>
